#define WINDOWS 


// Если запускаем в Windows, то для корректного вывода в консоль нужны доп действия
#ifdef WINDOWS

#define _CRT_SECURE_NO_WARNINGS
#include<windows.h>

#endif


#include <stdio.h>
#include <string.h>



enum encoding {
	CP_1251,
	KOI8_R, 
	ISO_8859_5,
	UTF_8,
	UNDEFINED
};



// Таблицы перекодирования созданы на основе информации из статьи https://wiki.iarduino.ru/page/encoding-arduino/ 

// Таблица перекодирования из Win1251 в UTF8
// В таблице ТОЛЬКО символы с кодами 128..255
// Нерусские символы будут заменены в UTF8 знаком '?' (код 0x3F)
unsigned char *ch_win1251_to_utf8[128] = {
	"?", // 128
	"?", // 129
	"?", // 130
	"?", // 131
	"?", // 132
	"?", // 133
	"?", // 134
	"?", // 135
	"?", // 136
	"?", // 137
	"?", // 138
	"?", // 139
	"?", // 140
	"?", // 141
	"?", // 142
	"?", // 143
	"?", // 144
	"?", // 145
	"?", // 146
	"?", // 147
	"?", // 148
	"?", // 149
	"?", // 150	
	"?", // 151
	"?", // 152
	"?", // 153
	"?", // 154
	"?", // 155
	"?", // 156
	"?", // 157
	"?", // 158
	"?", // 159
	"?", // 160	
	"?", // 161
	"?", // 162
	"?", // 163
	"?", // 164
	"?", // 165
	"?", // 166
	"?", // 167
	"\320\201", // 168 - Ё
	"?", // 169
	"?", // 170	
	"?", // 171
	"?", // 172
	"?", // 173
	"?", // 174
	"?", // 175
	"?", // 176
	"?", // 177
	"?", // 178
	"?", // 179
	"?", // 180	
	"?", // 181
	"?", // 182
	"?", // 183
	"\321\221", // 184 - ё
	"?", // 185
	"?", // 186
	"?", // 187
	"?", // 188
	"?", // 189
	"?", // 190	
	"?", // 191
	
	"\320\220", // 192 - А
	"\320\221", // 193 - Б
	"\320\222", // 194 - В
	"\320\223", // 195 - Г
	"\320\224", // 196 - Д
	"\320\225", // 197 - Е
	"\320\226", // 198 - Ж
	"\320\227", // 199 - З
	"\320\230", // 200 - И
	"\320\231", // 201 - Й
	"\320\232", // 202 - К
	"\320\233", // 203 - Л
	"\320\234", // 204 - М
	"\320\235", // 205 - Н
	"\320\236", // 206 - О
	"\320\237", // 207 - П

	"\320\240", // 208 - Р
	"\320\241", // 209 - С
	"\320\242", // 210 - Т
	"\320\243", // 211 - У
	"\320\244", // 212 - Ф
	"\320\245", // 213 - Х
	"\320\246", // 214 - Ц
	"\320\247", // 215 - Ч
	"\320\250", // 216 - Ш
	"\320\251", // 217 - Щ
	"\320\252", // 218 - Ъ
	"\320\253", // 219 - Ы
	"\320\254", // 220 - Ь
	"\320\255", // 221 - Э
	"\320\256", // 222 - Ю
	"\320\257", // 223 - Я


	"\320\260", // 224 - а
	"\320\261", // 225 - б
	"\320\262", // 226 - в
	"\320\263", // 227 - г
	"\320\264", // 228 - д
	"\320\265", // 229 - е
	"\320\266", // 230 - ж
	"\320\267", // 231 - з
	"\320\270", // 232 - и
	"\320\271", // 233 - й
	"\320\272", // 234 - к
	"\320\273", // 235 - л
	"\320\274", // 236 - м
	"\320\275", // 237 - н
	"\320\276", // 238 - о
	"\320\277", // 239 - п

	"\321\200", // 240 - р
	"\321\201", // 241 - с
	"\321\202", // 242 - т
	"\321\203", // 243 - у
	"\321\204", // 244 - ф
	"\321\205", // 245 - х
	"\321\206", // 246 - ц
	"\321\207", // 247 - ч
	"\321\210", // 248 - ш
	"\321\211", // 249 - щ
	"\321\212", // 250 - ъ
	"\321\213", // 251 - ы
	"\321\214", // 252 - ь
	"\321\215", // 253 - э
	"\321\216", // 254 - ю
	"\321\217", // 255 - я

};



// Таблица перекодирования из KOI8-R в UTF8
// В таблице ТОЛЬКО символы с кодами 128..255
// Нерусские символы будут заменены в UTF8 знаком '?' (код 0x3F)
unsigned char* ch_koi8_to_utf8[128] = {
	"?", // 128
	"?", // 129

	"?", // 130
	"?", // 131
	"?", // 132
	"?", // 133
	"?", // 134
	"?", // 135
	"?", // 136
	"?", // 137
	"?", // 138
	"?", // 139

	"?", // 140
	"?", // 141
	"?", // 142
	"?", // 143
	"?", // 144
	"?", // 145
	"?", // 146
	"?", // 147
	"?", // 148
	"?", // 149

	"?", // 150	
	"?", // 151
	"?", // 152
	"?", // 153
	"?", // 154
	"?", // 155
	"?", // 156
	"?", // 157
	"?", // 158
	"?", // 159

	"?", // 160	
	"?", // 161
	"?", // 162	
	"\321\221", // 163 - ё
	"?", // 164
	"?", // 165
	"?", // 166
	"?", // 167
	"?", // 168 
	"?", // 169

	"?", // 170	
	"?", // 171
	"?", // 172
	"?", // 173
	"?", // 174
	"?", // 175
	"?", // 176
	"?", // 177
	"?", // 178
	"\320\201", // 179 - Ё


	"?", // 180	
	"?", // 181
	"?", // 182
	"?", // 183
	"?", // 184
	"?", // 185
	"?", // 186
	"?", // 187
	"?", // 188
	"?", // 189

	"?", // 190	
	"?", // 191
	"\321\216", // 192 - ю
	"\320\260", // 193 - а
	"\320\261", // 194 - б
	"\321\206", // 195 - ц
	"\320\264", // 196 - д
	"\320\265", // 197 - е
	"\321\204", // 198 - ф
	"\320\263", // 199 - г

	"\321\205", // 200 - х
	"\320\270", // 201 - и
	"\320\271", // 202 - й
	"\320\272", // 203 - к
	"\320\273", // 204 - л
	"\320\274", // 205 - м
	"\320\275", // 206 - н
	"\320\276", // 207 - о
	"\320\277", // 208 - п	
	"\321\217", // 209 - я

	"\321\200", // 210 - р
	"\321\201", // 211 - с
	"\321\202", // 212 - т
	"\321\203", // 213 - у
	"\320\266", // 214 - ж
	"\320\262", // 215 - в
	"\321\214", // 216 - ь
	"\321\213", // 217 - ы
	"\320\267", // 218 - з
	"\321\210", // 219 - ш

	"\321\215", // 220 - э
	"\321\211", // 221 - щ
	"\321\207", // 222 - ч
	"\321\212", // 223 - ъ
	"\320\256", // 224 - Ю
	"\320\220", // 225 - А
	"\320\221", // 226 - Б
	"\320\246", // 227 - Ц
	"\320\224", // 228 - Д
	"\320\225", // 229 - Е

	"\320\244", // 230 - Ф
	"\320\223", // 231 - Г
	"\320\245", // 232 - Х
	"\320\230", // 233 - И
	"\320\231", // 234 - Й
	"\320\232", // 235 - К
	"\320\233", // 236 - Л
	"\320\234", // 237 - М
	"\320\235", // 238 - Н
	"\320\236", // 239 - О
	"\320\237", // 240 - П

	"\320\257", // 241 - Я
	"\320\240", // 242 - Р
	"\320\241", // 243 - С
	"\320\242", // 244 - Т
	"\320\243", // 245 - У		
	"\320\226", // 246 - Ж
	"\320\222", // 247 - В
	"\320\254", // 248 - Ь
	"\320\253", // 249 - Ы

	"\320\227", // 250 - З
	"\320\250", // 251 - Ш
	"\320\255", // 252 - Э
	"\320\251", // 253 - Щ
	"\320\247", // 254 - Ч
	"\320\252", // 255 - Ъe

};





// Таблица перекодирования из ISO-8859-5 в UTF8
// В таблице ТОЛЬКО символы с кодами 128..255
// Нерусские символы будут заменены в UTF8 знаком '?' (код 0x3F)
unsigned char* ch_iso8859_to_utf8[128] = {
	"?", // 128
	"?", // 129
	"?", // 130
	"?", // 131
	"?", // 132
	"?", // 133
	"?", // 134
	"?", // 135
	"?", // 136
	"?", // 137
	"?", // 138
	"?", // 139
	"?", // 140
	"?", // 141
	"?", // 142
	"?", // 143
	"?", // 144
	"?", // 145
	"?", // 146
	"?", // 147
	"?", // 148
	"?", // 149
	"?", // 150	
	"?", // 151
	"?", // 152
	"?", // 153
	"?", // 154
	"?", // 155
	"?", // 156
	"?", // 157
	"?", // 158
	"?", // 159
	"?", // 160	

	"\320\201", // 161 - Ё

	"?", // 162
	"?", // 163
	"?", // 164
	"?", // 165
	"?", // 166
	"?", // 167
	"?", // 168
	"?", // 169
	"?", // 170	
	"?", // 171
	"?", // 172
	"?", // 173
	"?", // 174
	"?", // 175

	"\320\220", // 176 - А
	"\320\221", // 177 - Б
	"\320\222", // 178 - В
	"\320\223", // 179 - Г
	"\320\224", // 180 - Д
	"\320\225", // 181 - Е
	"\320\226", // 182 - Ж
	"\320\227", // 183 - З
	"\320\230", // 184 - И
	"\320\231", // 185 - Й
	"\320\232", // 186 - К
	"\320\233", // 187 - Л
	"\320\234", // 188 - М
	"\320\235", // 189 - Н
	"\320\236", // 190 - О
	"\320\237", // 191 - П

	"\320\240", // 192 - Р
	"\320\241", // 193 - С
	"\320\242", // 194 - Т
	"\320\243", // 195 - У
	"\320\244", // 196 - Ф
	"\320\245", // 197 - Х
	"\320\246", // 198 - Ц
	"\320\247", // 199 - Ч
	"\320\250", // 200 - Ш
	"\320\251", // 201 - Щ
	"\320\252", // 202 - Ъ
	"\320\253", // 203 - Ы
	"\320\254", // 204 - Ь
	"\320\255", // 205 - Э
	"\320\256", // 206 - Ю
	"\320\257", // 207 - Я

	"\320\260", // 208 - а
	"\320\261", // 209 - б
	"\320\262", // 210 - в
	"\320\263", // 211 - г
	"\320\264", // 212 - д
	"\320\265", // 213 - е
	"\320\266", // 214 - ж
	"\320\267", // 215 - з
	"\320\270", // 216 - и
	"\320\271", // 217 - й
	"\320\272", // 218 - к
	"\320\273", // 219 - л
	"\320\274", // 220 - м
	"\320\275", // 221 - н
	"\320\276", // 222 - о
	"\320\277", // 223 - п

	"\321\200", // 224 - р
	"\321\201", // 225 - с
	"\321\202", // 226 - т
	"\321\203", // 227 - у
	"\321\204", // 228 - ф
	"\321\205", // 229 - х
	"\321\206", // 230 - ц
	"\321\207", // 231 - ч
	"\321\210", // 232 - ш
	"\321\211", // 233 - щ
	"\321\212", // 234 - ъ
	"\321\213", // 235 - ы
	"\321\214", // 236 - ь
	"\321\215", // 237 - э
	"\321\216", // 238 - ю
	"\321\217", // 239 - я

	"?", // 240
	"\321\221", // 241 - ё
	"?", // 242
	"?", // 243
	"?", // 244	
	"?", // 245
	"?", // 246
	"?", // 247
	"?", // 248
	"?", // 249

	"?", // 250
	"?", // 251
	"?", // 252
	"?", // 253
	"?", // 254
	"?", // 255

};


int convert_text_file(char* from_encoding, char* file_in, char* file_out) {

	enum encoding from_encode = UNDEFINED;

	if (strcmp("CP-1251", from_encoding) == 0) {
		// CP-1251 C:\Temp\Otus\HW2\cp1251.txt  C:\Temp\Otus\HW2\out.txt
		from_encode = CP_1251;
	}
	else if (strcmp("KOI8-R", from_encoding) == 0) {
		// KOI8-R C:\Temp\Otus\HW2\koi8.txt  C:\Temp\Otus\HW2\out2.txt
		from_encode = KOI8_R;
	}
	else if (strcmp("ISO-8859-5", from_encoding) == 0) {
		// ISO-8859-5 C:\Temp\Otus\HW2\iso-8859-5.txt  C:\Temp\Otus\HW2\out3.txt
		from_encode = ISO_8859_5;
	}
	else if (strcmp("UTF-8", from_encoding) == 0) {
		from_encode = UTF_8;
	}
	
	if (from_encode == UNDEFINED) {
		printf("from_encode == UNDEFINED!\n");
		return 0;
	}


	// открыть файл входной 
	FILE* fin = fopen(file_in, "r");
	if (fin == NULL) {
		// если файл не смогли открыть - сообщаем об этом
		printf("File in %s doesn't open!\n", file_in);
		return 0;
	}


	// открыть файл выходной
	FILE* fout = fopen(file_out, "w");
	if (fout == NULL) {
		// если файл не смогли открыть - сообщаем об этом
		printf("File out %s doesn't open!\n", file_out);


		fclose(fin);
		return 0;
	}

	//// пока не конец файла
	while (!feof(fin)) {
		int ch = getc(fin);
		if (ch == EOF) {
			break;
		}

		// символы с кодами от 0 до 127 просто переписываем в выходной файл
		if (ch < 128) {
			// Вывод в файл
			fputc(ch, fout);
			// контрольный вывод в консоль
			fputc(ch, stdout);
		}
		// символы с кодами от 128 до 255 перекодируем и затем пишем в выходной файл
		else {
			// получаем индекс в таблице перекодирования 
			int index = ch - 128;

			// указатель на строку, содержащую перекодированный символ
			char* symb = NULL;

			if (from_encode == CP_1251) {
				symb = ch_win1251_to_utf8[index];
			}
			else if (from_encode == KOI8_R) {
				symb = ch_koi8_to_utf8[index];
			}
			else if (from_encode == ISO_8859_5) {
				symb = ch_iso8859_to_utf8[index];
			}

			if (symb != NULL) {
				// Вывод в файл
				fputs(symb, fout);
				// контрольный вывод в консоль
				fputs(symb, stdout);
			}
		}		
	}

	fclose(fin);
	fclose(fout);

	return 1;
}


int main(int argc, char* argv[]) {

#ifdef WINDOWS
	SetConsoleOutputCP(65001);
#endif

	printf("It's HomeWork 02 by Oleg Vlasenko!\n");

	if (argc < 4) {
		printf("Format: from_encoding file_in file_out\n");
		return 0;
	}

	if (convert_text_file(argv[1], argv[2], argv[3])) {
		printf("File %s encoded by %s has converted to file %s\n", argv[2], argv[1], argv[3]);
		return 0;
	}

	return 0;

}